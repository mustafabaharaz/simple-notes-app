<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ProNotes Advanced</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #4361ee;
            --primary-dark: #3a56d4;
            --secondary: #f72585;
            --success: #4cc9f0;
            --warning: #fca311;
            --danger: #e63946;
            --light: #f8f9fa;
            --dark: #212529;
            --gray: #6c757d;
            --border: #dee2e6;
            --card-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            --transition: all 0.3s ease;
            --sidebar-width: 320px;
            --subject-color-1: #4361ee;
            --subject-color-2: #f72585;
            --subject-color-3: #4cc9f0;
            --subject-color-4: #fca311;
            --subject-color-5: #7209b7;
            --subject-color-6: #3a0ca3;
            --priority-normal: #a0aec0;
            --priority-low: #48bb78;
            --priority-medium: #ed8936;
            --priority-high: #e53e3e;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            background: linear-gradient(135deg, #f5f7fb 0%, #eef2ff 100%);
            color: var(--dark);
            height: 100vh;
            display: flex;
            overflow: hidden;
            line-height: 1.6;
        }
        
        /* Sidebar Styles */
        .sidebar {
            width: var(--sidebar-width);
            background: white;
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            height: 100vh;
            transition: var(--transition);
            box-shadow: var(--card-shadow);
            z-index: 10;
        }
        
        .sidebar-header {
            padding: 20px;
            background: var(--primary);
            color: white;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .app-title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 15px;
        }
        
        .search-container {
            position: relative;
            margin-bottom: 15px;
        }
        
        .search-input {
            width: 100%;
            padding: 12px 15px 12px 45px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            background: rgba(255, 255, 255, 0.15);
            color: white;
            transition: var(--transition);
        }
        
        .search-input:focus {
            background: rgba(255, 255, 255, 0.25);
            outline: none;
            box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.3);
        }
        
        .search-input::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }
        
        .search-icon {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: rgba(255, 255, 255, 0.7);
            font-size: 18px;
        }
        
        .header-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 8px;
        }
        
        .header-btn {
            padding: 10px 12px;
            border: none;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            color: white;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }
        
        .header-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }
        
        .header-btn.active {
            background: rgba(255, 255, 255, 0.4);
            font-weight: 600;
        }
        
        .bulk-actions {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 10px;
            margin-top: 10px;
            display: none;
        }
        
        .bulk-actions.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }
        
        .bulk-action-buttons {
            display: flex;
            gap: 8px;
        }
        
        .bulk-btn {
            flex: 1;
            padding: 8px 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }
        
        .delete-btn {
            background: var(--danger);
            color: white;
        }
        
        .cancel-btn {
            background: var(--gray);
            color: white;
        }
        
        /* Subjects Section */
        .subjects-section {
            padding: 15px;
            border-bottom: 1px solid var(--border);
            background: #f8f9ff;
        }
        
        .subjects-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .section-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .add-subject-btn {
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
        }
        
        .add-subject-btn:hover {
            background: var(--primary-dark);
            transform: rotate(90deg);
        }
        
        .subjects-container {
            max-height: 300px;
            overflow-y: auto;
        }
        
        .subject-item {
            padding: 12px 15px;
            background: white;
            border-radius: 8px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: move;
            transition: var(--transition);
            box-shadow: var(--card-shadow);
            border-left: 4px solid var(--subject-color-1);
        }
        
        .subject-item:nth-child(6n+2) { border-left-color: var(--subject-color-2); }
        .subject-item:nth-child(6n+3) { border-left-color: var(--subject-color-3); }
        .subject-item:nth-child(6n+4) { border-left-color: var(--subject-color-4); }
        .subject-item:nth-child(6n+5) { border-left-color: var(--subject-color-5); }
        .subject-item:nth-child(6n) { border-left-color: var(--subject-color-6); }
        
        .subject-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
        }
        
        .subject-item.active {
            background: linear-gradient(to right, #e0e7ff, #ffffff);
            border-left-color: var(--primary);
            transform: scale(1.02);
            box-shadow: 0 8px 25px rgba(67, 97, 238, 0.2);
        }
        
        .subject-icon {
            font-size: 20px;
            color: var(--primary);
        }
        
        .subject-name {
            flex: 1;
            font-weight: 500;
            color: var(--dark);
        }
        
        .note-count {
            background: #e0e7ff;
            color: var(--primary);
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .subject-actions {
            display: flex;
            gap: 8px;
            opacity: 0;
            transition: var(--transition);
        }
        
        .subject-item:hover .subject-actions {
            opacity: 1;
        }
        
        .subject-action-btn {
            background: none;
            border: none;
            color: var(--gray);
            cursor: pointer;
            transition: var(--transition);
        }
        
        .subject-action-btn:hover {
            color: var(--primary);
        }
        
        /* Notes List Styles */
        .notes-list {
            padding: 15px;
            overflow-y: auto;
            flex: 1;
        }
        
        .note-item {
            padding: 18px;
            border: 1px solid var(--border);
            border-radius: 12px;
            margin-bottom: 15px;
            cursor: pointer;
            background: white;
            transition: var(--transition);
            position: relative;
            box-shadow: var(--card-shadow);
            cursor: move;
        }
        
        .note-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
            border-color: var(--primary);
        }
        
        .note-item.active {
            border-color: var(--primary);
            background: linear-gradient(to right, #f0f4ff, #ffffff);
            box-shadow: 0 6px 16px rgba(67, 97, 238, 0.2);
        }
        
        .note-item.selected {
            border-color: var(--success);
            background: linear-gradient(to right, #e6fffa, #ffffff);
            box-shadow: 0 6px 16px rgba(76, 201, 240, 0.2);
        }
        
        .note-item.selected::before {
            content: '✓';
            position: absolute;
            top: 10px;
            right: 10px;
            background: var(--success);
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
        }
        
        .note-title {
            font-weight: 600;
            font-size: 18px;
            margin-bottom: 8px;
            color: var(--dark);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .note-subtitle {
            font-size: 14px;
            color: var(--gray);
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 10px;
        }
        
        .note-content-preview {
            font-size: 15px;
            color: var(--gray);
            margin-top: 8px;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            line-height: 1.6;
        }
        
        .note-tag {
            display: inline-block;
            background: #e0e7ff;
            color: var(--primary);
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 13px;
            margin-right: 8px;
            margin-top: 8px;
            font-weight: 500;
        }
        
        .importance-dot {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }
        
        .importance-dot.normal { background: var(--priority-normal); }
        .importance-dot.low { background: var(--priority-low); }
        .importance-dot.medium { background: var(--priority-medium); }
        .importance-dot.high { background: var(--priority-high); }
        
        /* Drag and Drop States */
        .subject-item.drag-over {
            background: #f0f7ff;
            transform: scale(1.02);
            box-shadow: 0 8px 25px rgba(67, 97, 238, 0.2);
        }
        
        .note-item.dragging {
            opacity: 0.5;
            transform: rotate(3deg);
        }
        
        /* Context Menu */
        .context-menu {
            position: fixed;
            background: white;
            border-radius: 8px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            display: none;
            min-width: 200px;
            overflow: hidden;
            animation: fadeIn 0.2s ease;
        }
        
        .context-menu-item {
            padding: 12px 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: var(--transition);
            border-bottom: 1px solid var(--border);
        }
        
        .context-menu-item:last-child {
            border-bottom: none;
        }
        
        .context-menu-item:hover {
            background: #f0f4ff;
        }
        
        .context-menu-item i {
            width: 20px;
            text-align: center;
        }
        
        .priority-selector {
            display: flex;
            gap: 8px;
            padding: 12px 20px;
            border-top: 1px solid var(--border);
            border-bottom: 1px solid var(--border);
            background: #f8f9ff;
        }
        
        .priority-option {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            cursor: pointer;
            transition: var(--transition);
            position: relative;
        }
        
        .priority-option:hover {
            transform: scale(1.2);
        }
        
        .priority-option::after {
            content: '';
            position: absolute;
            top: -4px;
            left: -4px;
            right: -4px;
            bottom: -4px;
            border-radius: 50%;
            border: 2px solid transparent;
            transition: var(--transition);
        }
        
        .priority-option.selected::after {
            border-color: var(--dark);
        }
        
        .priority-normal { background: var(--priority-normal); }
        .priority-low { background: var(--priority-low); }
        .priority-medium { background: var(--priority-medium); }
        .priority-high { background: var(--priority-high); }
        
        /* Trash Section */
        .trash-section {
            padding: 15px;
            border-top: 1px solid var(--border);
            background: #f8f9ff;
        }
        
        .trash-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
        }
        
        .trash-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--dark);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .empty-trash-btn {
            padding: 8px 15px;
            background: var(--danger);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: var(--transition);
        }
        
        .empty-trash-btn:hover {
            background: #c53030;
            transform: translateY(-2px);
        }
        
        .trash-list {
            max-height: 150px;
            overflow-y: auto;
        }
        
        .trash-item {
            padding: 12px;
            background: white;
            border-radius: 8px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 12px;
            box-shadow: var(--card-shadow);
            border-left: 4px solid var(--danger);
        }
        
        .trash-item-content {
            flex: 1;
        }
        
        .trash-item-title {
            font-weight: 500;
            margin-bottom: 4px;
        }
        
        .trash-item-date {
            font-size: 12px;
            color: var(--gray);
        }
        
        .restore-btn {
            background: none;
            border: none;
            color: var(--success);
            cursor: pointer;
            font-size: 16px;
        }
        
        /* Main Content Styles */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            height: 100vh;
            background: white;
            overflow: hidden;
        }
        
        .editor-header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
            background: white;
            position: relative;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            z-index: 5;
        }
        
        .note-title-field {
            width: 100%;
            padding: 12px 0;
            border: none;
            font-size: 32px;
            font-weight: 700;
            background: transparent;
            outline: none;
            color: var(--dark);
        }
        
        .note-title-field::placeholder {
            color: var(--gray);
            font-weight: 500;
        }
        
        .editor-toolbar {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 15px 20px;
            border-bottom: 1px solid var(--border);
            background: white;
            flex-wrap: wrap;
            overflow-x: auto;
        }
        
        .toolbar-group {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 0 10px;
            border-right: 1px solid var(--border);
        }
        
        .toolbar-group:last-child {
            border-right: none;
        }
        
        .toolbar-btn {
            padding: 10px 14px;
            border: 1px solid var(--border);
            background: white;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .toolbar-btn:hover {
            background: #f0f4ff;
            border-color: var(--primary);
        }
        
        .toolbar-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        
        .priority-btn.active.priority-low {
            background: var(--priority-low);
            border-color: var(--priority-low);
        }
        
        .priority-btn.active.priority-medium {
            background: var(--priority-medium);
            border-color: var(--priority-medium);
            color: var(--dark);
        }
        
        .priority-btn.active.priority-high {
            background: var(--priority-high);
            border-color: var(--priority-high);
        }
        
        .note-editor {
            flex: 1;
            padding: 30px;
            border: none;
            outline: none;
            font-size: 18px;
            line-height: 1.8;
            font-family: inherit;
            overflow-y: auto;
            background: white;
            transition: var(--transition);
        }
        
        .note-editor[data-placeholder]:empty::before {
            content: attr(data-placeholder);
            color: var(--gray);
            font-style: italic;
            font-size: 18px;
        }
        
        /* Drag and Drop States */
        .trash-section.drag-over {
            background: #fee2e2;
            transform: scale(1.02);
            box-shadow: 0 8px 25px rgba(230, 57, 70, 0.2);
        }
        
        /* Search Results Highlight */
        .search-highlight {
            background-color: #fff3cd;
            padding: 2px 4px;
            border-radius: 3px;
        }
        
        /* Modals & Notifications */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
            backdrop-filter: blur(5px);
        }
        
        .modal-overlay.active {
            opacity: 1;
            pointer-events: all;
        }
        
        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 30px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25);
            transform: translateY(30px);
            transition: transform 0.4s ease, opacity 0.4s ease;
            opacity: 0;
        }
        
        .modal-overlay.active .modal-content {
            transform: translateY(0);
            opacity: 1;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border);
        }
        
        .modal-title {
            font-size: 28px;
            font-weight: 700;
            color: var(--dark);
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: var(--gray);
            width: 45px;
            height: 45px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
        }
        
        .modal-close:hover {
            background: var(--light);
            color: var(--dark);
            transform: rotate(90deg);
        }
        
        .modal-body {
            margin-bottom: 25px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--dark);
        }
        
        .form-input {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 16px;
            transition: var(--transition);
        }
        
        .form-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.2);
        }
        
        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-primary {
            background: var(--primary);
            color: white;
        }
        
        .btn-primary:hover {
            background: var(--primary-dark);
        }
        
        .btn-secondary {
            background: var(--light);
            color: var(--dark);
        }
        
        .btn-secondary:hover {
            background: #e9ecef;
        }
        
        .notification {
            position: fixed;
            top: 25px;
            right: 25px;
            background: white;
            color: var(--dark);
            padding: 18px 28px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 500;
            z-index: 1000;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
            display: flex;
            align-items: center;
            gap: 15px;
            transform: translateX(120%);
            opacity: 0;
            transition: all 0.4s ease;
        }
        
        .notification.show {
            transform: translateX(0);
            opacity: 1;
        }
        
        .notification.success {
            border-left: 5px solid var(--success);
        }
        
        .notification.error {
            border-left: 5px solid var(--danger);
        }
        
        .notification.warning {
            border-left: 5px solid var(--warning);
        }
        
        /* Template Grid */
        .templates-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .template-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: var(--card-shadow);
            border: 2px solid transparent;
        }
        
        .template-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 25px rgba(0, 0, 0, 0.12);
            border-color: var(--primary);
        }
        
        .template-icon {
            font-size: 42px;
            margin-bottom: 15px;
            color: var(--primary);
        }
        
        .template-title {
            font-size: 22px;
            font-weight: 700;
            margin-bottom: 10px;
            color: var(--dark);
        }
        
        .template-description {
            font-size: 15px;
            color: var(--gray);
            margin-bottom: 15px;
            line-height: 1.6;
        }
        
        .template-preview {
            background: #f8f9ff;
            border: 1px dashed var(--primary);
            border-radius: 10px;
            padding: 15px;
            font-size: 14px;
            color: var(--dark);
            line-height: 1.7;
            max-height: 150px;
            overflow-y: auto;
        }
        
        .template-category {
            display: inline-block;
            background: #e0f7ff;
            color: var(--success);
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin-top: 10px;
        }
        
        /* Responsive design */
        @media (max-width: 992px) {
            .sidebar {
                position: absolute;
                left: calc(-1 * var(--sidebar-width));
            }
            
            .sidebar.active {
                left: 0;
            }
            
            .toggle-sidebar {
                display: block !important;
            }
        }
        
        @media (max-width: 768px) {
            .editor-toolbar {
                padding: 12px;
                gap: 8px;
            }
            
            .toolbar-group {
                padding: 0 8px;
            }
            
            .toolbar-btn {
                padding: 8px 12px;
                font-size: 13px;
            }
            
            .note-editor {
                padding: 20px;
                font-size: 16px;
            }
            
            .modal-content {
                width: 95%;
                padding: 20px;
            }
            
            .templates-grid {
                grid-template-columns: 1fr;
            }
        }
        
        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Utility classes */
        .flex {
            display: flex;
        }
        
        .items-center {
            align-items: center;
        }
        
        .justify-between {
            justify-content: space-between;
        }
        
        .gap-2 {
            gap: 8px;
        }
        
        .gap-3 {
            gap: 12px;
        }
        
        .gap-4 {
            gap: 16px;
        }
        
        .mb-3 {
            margin-bottom: 15px;
        }
        
        .mb-4 {
            margin-bottom: 20px;
        }
        
        .mt-2 {
            margin-top: 8px;
        }
        
        .mt-3 {
            margin-top: 15px;
        }
        
        .icon {
            font-size: 20px;
        }
        
        .toggle-sidebar {
            position: absolute;
            top: 25px;
            left: 25px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: none;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 20;
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.15);
            font-size: 24px;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--gray);
        }
        
        .empty-state i {
            font-size: 48px;
            margin-bottom: 15px;
            color: var(--border);
        }
    </style>
</head>
<body>
    <button class="toggle-sidebar" id="toggle-sidebar">
        <i class="fas fa-bars"></i>
    </button>
    
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="app-title">
                <i class="fas fa-edit"></i>
                <h1>ProNotes Advanced</h1>
            </div>
            
            <div class="search-container">
                <i class="fas fa-search search-icon"></i>
                <input type="text" id="search-notes" class="search-input" placeholder="Search notes...">
            </div>
            
            <div class="header-buttons">
                <button class="header-btn" id="new-note">
                    <i class="fas fa-plus"></i> New
                </button>
                <button class="header-btn" id="templates-btn">
                    <i class="fas fa-layer-group"></i> Templates
                </button>
                <button class="header-btn" id="select-mode">
                    <i class="fas fa-check-square"></i> Select
                </button>
                <button class="header-btn" id="show-all-notes">
                    <i class="fas fa-sticky-note"></i> All Notes
                </button>
            </div>
            
            <div class="bulk-actions" id="bulk-actions">
                <div class="bulk-action-buttons">
                    <button class="bulk-btn delete-btn" id="bulk-delete">
                        <i class="fas fa-trash"></i> Delete Selected
                    </button>
                    <button class="bulk-btn cancel-btn" id="cancel-selection">
                        <i class="fas fa-times"></i> Cancel
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Subjects Section -->
        <div class="subjects-section">
            <div class="subjects-header">
                <div class="section-title">
                    <i class="fas fa-folder"></i>
                    <h3>Subjects</h3>
                </div>
                <button class="add-subject-btn" id="add-subject-btn">
                    <i class="fas fa-plus"></i>
                </button>
            </div>
            
            <div class="subjects-container" id="subjects-container">
                <!-- Subjects will be rendered here dynamically -->
            </div>
        </div>
        
        <!-- Notes List -->
        <div class="notes-list" id="notes-list">
            <!-- Notes will be rendered here dynamically -->
        </div>
        
        <!-- Trash Section -->
        <div class="trash-section" id="trash-section">
            <div class="trash-header">
                <div class="trash-title">
                    <i class="fas fa-trash"></i>
                    <h3>Trash</h3>
                </div>
                <button class="empty-trash-btn" id="empty-trash">
                    <i class="fas fa-broom"></i> Empty
                </button>
            </div>
            <div class="trash-list" id="trash-list">
                <!-- Trash items will be rendered here dynamically -->
            </div>
        </div>
    </div>
    
    <div class="main-content">
        <div class="editor-header">
            <input type="text" id="note-title-field" class="note-title-field" placeholder="Note title..." />
        </div>
        
        <div class="editor-toolbar">
            <div class="toolbar-group">
                <button class="toolbar-btn" id="bold-btn">
                    <i class="fas fa-bold"></i> Bold
                </button>
                <button class="toolbar-btn" id="italic-btn">
                    <i class="fas fa-italic"></i> Italic
                </button>
            </div>
            
            <div class="toolbar-group">
                <button class="toolbar-btn" id="bullet-btn">
                    <i class="fas fa-list"></i> List
                </button>
                <button class="toolbar-btn" id="date-btn">
                    <i class="fas fa-calendar"></i> Date
                </button>
            </div>
            
            <div class="toolbar-group">
                <button class="toolbar-btn priority-btn" id="priority-normal">
                    Normal
                </button>
                <button class="toolbar-btn priority-btn priority-low" id="priority-low">
                    Low
                </button>
                <button class="toolbar-btn priority-btn priority-medium" id="priority-medium">
                    Medium
                </button>
                <button class="toolbar-btn priority-btn priority-high" id="priority-high">
                    High
                </button>
            </div>
            
            <div class="toolbar-group">
                <button class="toolbar-btn" id="remind-me-btn">
                    <i class="fas fa-bell"></i> Remind
                </button>
            </div>
            
            <div class="toolbar-group">
                <button class="toolbar-btn" id="clear-btn">
                    <i class="fas fa-broom"></i> Clear
                </button>
            </div>
        </div>
        
        <div id="note-editor" class="note-editor" contenteditable="true" data-placeholder="Start writing your note here..."></div>
    </div>
    
    <!-- Subject Modal -->
    <div class="modal-overlay" id="subject-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="subject-modal-title">
                    <i class="fas fa-folder"></i> Add New Subject
                </h2>
                <button class="modal-close" id="subject-modal-close">&times;</button>
            </div>
            
            <div class="modal-body">
                <div class="form-group">
                    <label for="subject-name" class="form-label">Subject Name</label>
                    <input type="text" id="subject-name" class="form-input" placeholder="Enter subject name">
                </div>
            </div>
            
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancel-subject-btn">
                    Cancel
                </button>
                <button class="btn btn-primary" id="save-subject-btn">
                    Save Subject
                </button>
            </div>
        </div>
    </div>
    
    <!-- Templates Modal -->
    <div class="modal-overlay" id="templates-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">
                    <i class="fas fa-layer-group"></i> Note Templates
                </h2>
                <button class="modal-close" id="templates-modal-close">&times;</button>
            </div>
            
            <div class="templates-grid" id="templates-container">
                <!-- Templates will be rendered here dynamically -->
            </div>
        </div>
    </div>
    
    <!-- Context Menu -->
    <div id="context-menu" class="context-menu">
        <div class="context-menu-item" id="context-delete">
            <i class="fas fa-trash"></i>
            <span>Delete Note</span>
        </div>
        <div class="context-menu-item" id="context-duplicate">
            <i class="fas fa-copy"></i>
            <span>Duplicate Note</span>
        </div>
        <div class="priority-selector">
            <div class="priority-option priority-normal" data-priority="normal" title="Normal"></div>
            <div class="priority-option priority-low" data-priority="low" title="Low Priority"></div>
            <div class="priority-option priority-medium" data-priority="medium" title="Medium Priority"></div>
            <div class="priority-option priority-high" data-priority="high" title="High Priority"></div>
        </div>
        <div class="context-menu-item" id="context-add-tag">
            <i class="fas fa-tag"></i>
            <span>Add Tag</span>
        </div>
        <div class="context-menu-item" id="context-set-reminder">
            <i class="fas fa-bell"></i>
            <span>Set Reminder</span>
        </div>
    </div>
    
    <!-- Notification container -->
    <div id="notification-container"></div>
    
    <script>
        // =====================================================
        // Professional Templates
        // =====================================================
        const templates = [
            {
                id: 'class-notes',
                title: 'Class Notes',
                icon: 'fas fa-graduation-cap',
                category: 'Education',
                description: 'Structured format for taking lecture notes',
                content: `<h2>Class: [Subject Name]</h2>
                <p><strong>Date:</strong> [Date]</p>
                <p><strong>Professor:</strong> [Professor Name]</p>
                <p><strong>Topic:</strong> [Lecture Topic]</p>
                
                <h3>Key Concepts:</h3>
                <ul>
                    <li>[Concept 1] - Explanation</li>
                    <li>[Concept 2] - Explanation</li>
                    <li>[Concept 3] - Explanation</li>
                </ul>
                
                <h3>Important Formulas:</h3>
                <ul>
                    <li>[Formula 1] - Description</li>
                    <li>[Formula 2] - Description</li>
                </ul>
                
                <h3>Homework:</h3>
                <ul>
                    <li>[Assignment 1] - Due Date</li>
                    <li>[Assignment 2] - Due Date</li>
                </ul>
                
                <h3>Questions to Ask:</h3>
                <ul>
                    <li>[Question 1]</li>
                    <li>[Question 2]</li>
                </ul>`
            },
            {
                id: 'meeting-notes',
                title: 'Meeting Notes',
                icon: 'fas fa-users',
                category: 'Professional',
                description: 'Format for capturing meeting discussions and action items',
                content: `<h2>Meeting: [Meeting Title]</h2>
                <p><strong>Date:</strong> [Date] | <strong>Time:</strong> [Start] - [End]</p>
                <p><strong>Location:</strong> [Meeting Room/Online]</p>
                <p><strong>Attendees:</strong> [Name 1], [Name 2], [Name 3]</p>
                
                <h3>Agenda:</h3>
                <ol>
                    <li>[Agenda Item 1]</li>
                    <li>[Agenda Item 2]</li>
                    <li>[Agenda Item 3]</li>
                </ol>
                
                <h3>Discussion Points:</h3>
                <ul>
                    <li><strong>Topic 1:</strong> Key discussion points and decisions</li>
                    <li><strong>Topic 2:</strong> Key discussion points and decisions</li>
                </ul>
                
                <h3>Action Items:</h3>
                <table style="width:100%; border-collapse: collapse;">
                    <tr>
                        <th style="text-align:left; padding:8px; border-bottom:1px solid #ddd;">Task</th>
                        <th style="text-align:left; padding:8px; border-bottom:1px solid #ddd;">Owner</th>
                        <th style="text-align:left; padding:8px; border-bottom:1px solid #ddd;">Due Date</th>
                    </tr>
                    <tr>
                        <td style="padding:8px; border-bottom:1px solid #ddd;">[Task Description]</td>
                        <td style="padding:8px; border-bottom:1px solid #ddd;">[Owner Name]</td>
                        <td style="padding:8px; border-bottom:1px solid #ddd;">[Due Date]</td>
                    </tr>
                    <tr>
                        <td style="padding:8px; border-bottom:1px solid #ddd;">[Task Description]</td>
                        <td style="padding:8px; border-bottom:1px solid #ddd;">[Owner Name]</td>
                        <td style="padding:8px; border-bottom:1px solid #ddd;">[Due Date]</td>
                    </tr>
                </table>
                
                <h3>Next Meeting:</h3>
                <p>[Date] at [Time] - [Location]</p>`
            },
            {
                id: 'project-plan',
                title: 'Project Plan',
                icon: 'fas fa-project-diagram',
                category: 'Professional',
                description: 'Template for outlining project goals and timelines',
                content: `<h1>[Project Name] Project Plan</h1>
                
                <h2>Project Overview</h2>
                <p><strong>Goal:</strong> [Project Goal]</p>
                <p><strong>Start Date:</strong> [Date]</p>
                <p><strong>Target Completion:</strong> [Date]</p>
                <p><strong>Project Manager:</strong> [Name]</p>
                <p><strong>Team Members:</strong> [Name 1], [Name 2], [Name 3]</p>
                
                <h2>Objectives</h2>
                <ol>
                    <li>[Objective 1]</li>
                    <li>[Objective 2]</li>
                    <li>[Objective 3]</li>
                </ol>
                
                <h2>Milestones</h2>
                <table style="width:100%; border-collapse: collapse;">
                    <tr>
                        <th style="text-align:left; padding:8px; border-bottom:1px solid #ddd;">Milestone</th>
                        <th style="text-align:left; padding:8px; border-bottom:1px solid #ddd;">Target Date</th>
                        <th style="text-align:left; padding:8px; border-bottom:1px solid #ddd;">Owner</th>
                        <th style="text-align:left; padding:8px; border-bottom:1px solid #ddd;">Status</th>
                    </tr>
                    <tr>
                        <td style="padding:8px; border-bottom:1px solid #ddd;">[Milestone 1]</td>
                        <td style="padding:8px; border-bottom:1px solid #ddd;">[Date]</td>
                        <td style="padding:8px; border-bottom:1px solid #ddd;">[Owner]</td>
                        <td style="padding:8px; border-bottom:1px solid #ddd;">Not Started</td>
                    </tr>
                    <tr>
                        <td style="padding:8px; border-bottom:1px solid #ddd;">[Milestone 2]</td>
                        <td style="padding:8px; border-bottom:1px solid #ddd;">[Date]</td>
                        <td style="padding:8px; border-bottom:1px solid #ddd;">[Owner]</td>
                        <td style="padding:8px; border-bottom:1px solid #ddd;">Not Started</td>
                    </tr>
                </table>
                
                <h2>Resources</h2>
                <ul>
                    <li>[Resource 1]</li>
                    <li>[Resource 2]</li>
                </ul>
                
                <h2>Risks & Challenges</h2>
                <ul>
                    <li>[Risk 1] - Mitigation plan</li>
                    <li>[Risk 2] - Mitigation plan</li>
                </ul>`
            },
            {
                id: 'work-log',
                title: 'Daily Work Log',
                icon: 'fas fa-hard-hat',
                category: 'Blue Collar',
                description: 'Template for tracking daily tasks and progress',
                content: `<h1>Daily Work Log: [Date]</h1>
                <p><strong>Job Site:</strong> [Site Name/Location]</p>
                <p><strong>Foreman:</strong> [Name]</p>
                <p><strong>Crew:</strong> [Name 1], [Name 2], [Name 3]</p>
                <p><strong>Weather:</strong> [Conditions] | <strong>Temperature:</strong> [Range]</p>
                
                <h2>Tasks Completed</h2>
                <table style="width:100%; border-collapse: collapse;">
                    <tr>
                        <th style="text-align:left; padding:8px; border-bottom:1px solid #ddd;">Task</th>
                        <th style="text-align:left; padding:8px; border-bottom:1px solid #ddd;">Crew</th>
                        <th style="text-align:left; padding:8px; border-bottom:1px solid #ddd;">Hours</th>
                        <th style="text-align:left; padding:8px; border-bottom:1px solid #ddd;">Status</th>
                    </tr>
                    <tr>
                        <td style="padding:8px; border-bottom:1px solid #ddd;">[Task Description]</td>
                        <td style="padding:8px; border-bottom:1px solid #ddd;">[Crew Members]</td>
                        <td style="padding:8px; border-bottom:1px solid #ddd;">[Hours]</td>
                        <td style="padding:8px; border-bottom:1px solid #ddd;">Completed</td>
                    </tr>
                    <tr>
                        <td style="padding:8px; border-bottom:1px solid #ddd;">[Task Description]</td>
                        <td style="padding:8px; border-bottom:1px solid #ddd;">[Crew Members]</td>
                        <td style="padding:8px; border-bottom:1px solid #ddd;">[Hours]</td>
                        <td style="padding:8px; border-bottom:1px solid #ddd;">In Progress</td>
                    </tr>
                </table>
                
                <h2>Materials Used</h2>
                <table style="width:100%; border-collapse: collapse;">
                    <tr>
                        <th style="text-align:left; padding:8px; border-bottom:1px solid #ddd;">Material</th>
                        <th style="text-align:left; padding:8px; border-bottom:1px solid #ddd;">Quantity</th>
                        <th style="text-align:left; padding:8px; border-bottom:1px solid #ddd;">Notes</th>
                    </tr>
                    <tr>
                        <td style="padding:8px; border-bottom:1px solid #ddd;">[Material Name]</td>
                        <td style="padding:8px; border-bottom:1px solid #ddd;">[Quantity]</td>
                        <td style="padding:8px; border-bottom:1px solid #ddd;">[Notes]</td>
                    </tr>
                </table>
                
                <h2>Equipment Issues</h2>
                <ul>
                    <li>[Equipment 1] - [Issue Description]</li>
                    <li>[Equipment 2] - [Issue Description]</li>
                </ul>
                
                <h2>Safety Observations</h2>
                <ul>
                    <li>[Observation 1]</li>
                    <li>[Observation 2]</li>
                </ul>
                
                <h2>Plan for Tomorrow</h2>
                <ol>
                    <li>[Task 1]</li>
                    <li>[Task 2]</li>
                </ol>`
            },
            {
                id: 'research-notes',
                title: 'Research Notes',
                icon: 'fas fa-microscope',
                category: 'Education',
                description: 'Template for academic research and findings',
                content: `<h1>Research: [Topic]</h1>
                <p><strong>Date:</strong> [Date]</p>
                <p><strong>Researcher:</strong> [Your Name]</p>
                
                <h2>Research Question</h2>
                <p>[Your research question]</p>
                
                <h2>Hypothesis</h2>
                <p>[Your hypothesis]</p>
                
                <h2>Sources</h2>
                <ul>
                    <li>[Source 1] - Key findings</li>
                    <li>[Source 2] - Key findings</li>
                    <li>[Source 3] - Key findings</li>
                </ul>
                
                <h2>Methodology</h2>
                <p>[Description of research methods used]</p>
                
                <h2>Data Collected</h2>
                <table style="width:100%; border-collapse: collapse;">
                    <tr>
                        <th style="text-align:left; padding:8px; border-bottom:1px solid #ddd;">Data Point</th>
                        <th style="text-align:left; padding:8px; border-bottom:1px solid #ddd;">Value</th>
                        <th style="text-align:left; padding:8px; border-bottom:1px solid #ddd;">Notes</th>
                    </tr>
                    <tr>
                        <td style="padding:8px; border-bottom:1px solid #ddd;">[Data 1]</td>
                        <td style="padding:8px; border-bottom:1px solid #ddd;">[Value]</td>
                        <td style="padding:8px; border-bottom:1px solid #ddd;">[Note]</td>
                    </tr>
                </table>
                
                <h2>Findings</h2>
                <p>[Summary of research findings]</p>
                
                <h2>Conclusions</h2>
                <p>[Conclusions drawn from research]</p>
                
                <h2>Next Steps</h2>
                <ul>
                    <li>[Next action 1]</li>
                    <li>[Next action 2]</li>
                </ul>`
            },
            {
                id: 'health-log',
                title: 'Health & Safety Log',
                icon: 'fas fa-heartbeat',
                category: 'Blue Collar',
                description: 'Template for tracking health and safety observations',
                content: `<h1>Health & Safety Log</h1>
                <p><strong>Site:</strong> [Location]</p>
                <p><strong>Date:</strong> [Date]</p>
                <p><strong>Supervisor:</strong> [Name]</p>
                
                <h2>Safety Equipment Check</h2>
                <table style="width:100%; border-collapse: collapse;">
                    <tr>
                        <th style="text-align:left; padding:8px; border-bottom:1px solid #ddd;">Equipment</th>
                        <th style="text-align:left; padding:8px; border-bottom:1px solid #ddd;">Status</th>
                        <th style="text-align:left; padding:8px; border-bottom:1px solid #ddd;">Notes</th>
                    </tr>
                    <tr>
                        <td style="padding:8px; border-bottom:1px solid #ddd;">Hard Hats</td>
                        <td style="padding:8px; border-bottom:1px solid #ddd;">Good</td>
                        <td style="padding:8px; border-bottom:1px solid #ddd;">All accounted for</td>
                    </tr>
                    <tr>
                        <td style="padding:8px; border-bottom:1px solid #ddd;">Safety Harnesses</td>
                        <td style="padding:8px; border-bottom:1px solid #ddd;">Needs Replacement</td>
                        <td style="padding:8px; border-bottom:1px solid #ddd;">2 harnesses worn</td>
                    </tr>
                </table>
                
                <h2>Incident Reports</h2>
                <p><strong>No incidents today</strong></p>
                
                <h2>Near Misses</h2>
                <ul>
                    <li>[Description of near miss]</li>
                    <li>[Description of near miss]</li>
                </ul>
                
                <h2>Safety Training Completed</h2>
                <ul>
                    <li>[Training Topic] - [Crew Members]</li>
                </ul>
                
                <h2>Environmental Conditions</h2>
                <p><strong>Temperature:</strong> [Value]°C</p>
                <p><strong>Weather:</strong> [Conditions]</p>
                <p><strong>Air Quality:</strong> [Rating]</p>
                
                <h2>Corrective Actions</h2>
                <ul>
                    <li>[Action 1] - [Assigned to] - [Due Date]</li>
                    <li>[Action 2] - [Assigned to] - [Due Date]</li>
                </ul>`
            },
            {
                id: 'client-meeting',
                title: 'Client Meeting',
                icon: 'fas fa-handshake',
                category: 'Professional',
                description: 'Template for client meetings and follow-ups',
                content: `<h1>Client Meeting: [Client Name]</h1>
                <p><strong>Date:</strong> [Date]</p>
                <p><strong>Attendees:</strong> [Names]</p>
                <p><strong>Purpose:</strong> [Meeting Purpose]</p>
                
                <h2>Agenda Items</h2>
                <ol>
                    <li>[Agenda Item 1]</li>
                    <li>[Agenda Item 2]</li>
                    <li>[Agenda Item 3]</li>
                </ol>
                
                <h2>Client Feedback</h2>
                <ul>
                    <li><strong>Positive:</strong> [Feedback]</li>
                    <li><strong>Concerns:</strong> [Feedback]</li>
                    <li><strong>Requests:</strong> [Feedback]</li>
                </ul>
                
                <h2>Decisions Made</h2>
                <ul>
                    <li>[Decision 1]</li>
                    <li>[Decision 2]</li>
                </ul>
                
                <h2>Action Items</h2>
                <table style="width:100%; border-collapse: collapse;">
                    <tr>
                        <th style="text-align:left; padding:8px; border-bottom:1px solid #ddd;">Task</th>
                        <th style="text-align:left; padding:8px; border-bottom:1px solid #ddd;">Owner</th>
                        <th style="text-align:left; padding:8px; border-bottom:1px solid #ddd;">Due Date</th>
                    </tr>
                    <tr>
                        <td style="padding:8px; border-bottom:1px solid #ddd;">[Task Description]</td>
                        <td style="padding:8px; border-bottom:1px solid #ddd;">[Name]</td>
                        <td style="padding:8px; border-bottom:1px solid #ddd;">[Date]</td>
                    </tr>
                </table>
                
                <h2>Next Steps</h2>
                <ul>
                    <li>[Step 1]</li>
                    <li>[Step 2]</li>
                </ul>
                
                <h2>Next Meeting</h2>
                <p>[Date] at [Time] - [Location/Online]</p>`
            },
            {
                id: 'inventory',
                title: 'Inventory Tracker',
                icon: 'fas fa-boxes',
                category: 'Blue Collar',
                description: 'Template for tracking inventory and supplies',
                content: `<h1>Inventory: [Location/Project]</h1>
                <p><strong>Date:</strong> [Date]</p>
                <p><strong>Conducted By:</strong> [Name]</p>
                
                <h2>Materials Inventory</h2>
                <table style="width:100%; border-collapse: collapse;">
                    <tr>
                        <th style="text-align:left; padding:8px; border-bottom:1px solid #ddd;">Item</th>
                        <th style="text-align:left; padding:8px; border-bottom:1px solid #ddd;">Category</th>
                        <th style="text-align:left; padding:8px; border-bottom:1px solid #ddd;">Current Stock</th>
                        <th style="text-align:left; padding:8px; border-bottom:1px solid #ddd;">Min Required</th>
                        <th style="text-align:left; padding:8px; border-bottom:1px solid #ddd;">To Order</th>
                    </tr>
                    <tr>
                        <td style="padding:8px; border-bottom:1px solid #ddd;">[Item Name]</td>
                        <td style="padding:8px; border-bottom:1px solid #ddd;">[Category]</td>
                        <td style="padding:8px; border-bottom:1px solid #ddd;">[Quantity]</td>
                        <td style="padding:8px; border-bottom:1px solid #ddd;">[Min Quantity]</td>
                        <td style="padding:8px; border-bottom:1px solid #ddd;">[Order Quantity]</td>
                    </tr>
                </table>
                
                <h2>Equipment Status</h2>
                <table style="width:100%; border-collapse: collapse;">
                    <tr>
                        <th style="text-align:left; padding:8px; border-bottom:1px solid #ddd;">Equipment</th>
                        <th style="text-align:left; padding:8px; border-bottom:1px solid #ddd;">Status</th>
                        <th style="text-align:left; padding:8px; border-bottom:1px solid #ddd;">Last Maintenance</th>
                        <th style="text-align:left; padding:8px; border-bottom:1px solid #ddd;">Next Maintenance</th>
                    </tr>
                    <tr>
                        <td style="padding:8px; border-bottom:1px solid #ddd;">[Equipment Name]</td>
                        <td style="padding:8px; border-bottom:1px solid #ddd;">Operational</td>
                        <td style="padding:8px; border-bottom:1px solid #ddd;">[Date]</td>
                        <td style="padding:8px; border-bottom:1px solid #ddd;">[Date]</td>
                    </tr>
                </table>
                
                <h2>Order Requests</h2>
                <ul>
                    <li>[Item 1] - [Quantity] - [Urgency]</li>
                    <li>[Item 2] - [Quantity] - [Urgency]</li>
                </ul>
                
                <h2>Notes</h2>
                <p>[Additional observations]</p>`
            }
        ];

        // =====================================================
        // App State Management
        // =====================================================
        const AppState = {
            subjects: [
                { id: 'subj-1', name: 'Mathematics', notes: [] },
                { id: 'subj-2', name: 'Science', notes: [] },
                { id: 'subj-3', name: 'History', notes: [] },
                { id: 'subj-4', name: 'Projects', notes: [] }
            ],
            notes: [],
            trash: [],
            currentNoteId: null,
            currentSubjectId: null,
            isSelectionMode: false,
            selectedNoteIds: new Set(),
            searchQuery: '',
            filteredNotes: [],
            editingSubjectId: null,
            contextNoteId: null,
            
            // Initialize app data
            init() {
                this.loadData();
                this.renderUI();
            },
            
            // Load data from storage
            loadData() {
                try {
                    const savedData = JSON.parse(localStorage.getItem('proNotesData') || '{}');
                    this.subjects = savedData.subjects || this.subjects;
                    this.notes = savedData.notes || [];
                    this.trash = savedData.trash || [];
                    this.currentNoteId = savedData.currentNoteId || null;
                    this.currentSubjectId = savedData.currentSubjectId || null;
                } catch (error) {
                    console.error('Error loading data:', error);
                    this.showNotification('Error loading saved data', 'error');
                }
            },
            
            // Save data to storage
            saveData() {
                try {
                    const data = {
                        subjects: this.subjects,
                        notes: this.notes,
                        trash: this.trash,
                        currentNoteId: this.currentNoteId,
                        currentSubjectId: this.currentSubjectId
                    };
                    localStorage.setItem('proNotesData', JSON.stringify(data));
                } catch (error) {
                    console.error('Error saving data:', error);
                    this.showNotification('Error saving data', 'error');
                }
            },
            
            // Create a new note
            createNote(title = 'New Note', content = '') {
                const id = 'note' + Date.now();
                const newNote = {
                    id,
                    title,
                    content: DOMPurify.sanitize(content),
                    created: new Date().toISOString().split('T')[0],
                    updated: new Date().toISOString().split('T')[0],
                    importance: "normal",
                    tags: [],
                    subjectId: this.currentSubjectId
                };
                
                this.notes.unshift(newNote);
                this.currentNoteId = id;
                
                if (this.currentSubjectId) {
                    this.addNoteToSubject(id, this.currentSubjectId);
                }
                
                this.saveData();
                return newNote;
            },
            
            // Create a note from template
            createFromTemplate(template) {
                const id = 'note' + Date.now();
                const newNote = {
                    id,
                    title: template.title + ' ' + new Date().toLocaleDateString(),
                    content: DOMPurify.sanitize(template.content),
                    created: new Date().toISOString().split('T')[0],
                    updated: new Date().toISOString().split('T')[0],
                    importance: "normal",
                    tags: [template.category],
                    subjectId: this.currentSubjectId
                };
                
                this.notes.unshift(newNote);
                this.currentNoteId = id;
                
                if (this.currentSubjectId) {
                    this.addNoteToSubject(id, this.currentSubjectId);
                }
                
                this.saveData();
                return newNote;
            },
            
            // Update a note
            updateNote(id, updates) {
                const note = this.notes.find(n => n.id === id);
                if (!note) return;
                
                // Sanitize content if it's being updated
                if (updates.content) {
                    updates.content = DOMPurify.sanitize(updates.content);
                }
                
                Object.assign(note, updates, {
                    updated: new Date().toISOString().split('T')[0]
                });
                
                this.saveData();
                return note;
            },
            
            // Delete a note (move to trash)
            deleteNote(id) {
                const noteIndex = this.notes.findIndex(n => n.id === id);
                if (noteIndex === -1) return;
                
                const deletedNote = this.notes.splice(noteIndex, 1)[0];
                deletedNote.deletedAt = new Date().toISOString().split('T')[0];
                this.trash.push(deletedNote);
                
                if (this.currentNoteId === id) {
                    this.currentNoteId = this.notes.length > 0 ? this.notes[0].id : null;
                }
                
                if (deletedNote.subjectId) {
                    this.removeNoteFromSubject(id, deletedNote.subjectId);
                }
                
                this.saveData();
            },
            
            // Bulk delete selected notes
            bulkDeleteNotes() {
                const selectedIds = Array.from(this.selectedNoteIds);
                selectedIds.forEach(id => this.deleteNote(id));
                this.selectedNoteIds.clear();
                this.exitSelectionMode();
                this.renderUI();
                this.showNotification(`${selectedIds.length} notes moved to trash`, 'warning');
            },
            
            // Restore a note from trash
            restoreNote(id) {
                const noteIndex = this.trash.findIndex(n => n.id === id);
                if (noteIndex === -1) return;
                
                const restoredNote = this.trash.splice(noteIndex, 1)[0];
                delete restoredNote.deletedAt;
                this.notes.unshift(restoredNote);
                
                if (restoredNote.subjectId) {
                    this.addNoteToSubject(id, restoredNote.subjectId);
                }
                
                this.saveData();
            },
            
            // Empty trash
            emptyTrash() {
                this.trash = [];
                this.saveData();
            },
            
            // Create a new subject
            createSubject(name) {
                const id = 'subj-' + Date.now();
                const newSubject = {
                    id,
                    name: DOMPurify.sanitize(name),
                    notes: []
                };
                
                this.subjects.push(newSubject);
                this.saveData();
                return newSubject;
            },
            
            // Rename a subject
            renameSubject(subjectId, newName) {
                const subject = this.subjects.find(s => s.id === subjectId);
                if (subject) {
                    subject.name = DOMPurify.sanitize(newName);
                    this.saveData();
                    return true;
                }
                return false;
            },
            
            // Delete a subject
            deleteSubject(subjectId) {
                const subjectIndex = this.subjects.findIndex(s => s.id === subjectId);
                if (subjectIndex === -1) return false;
                
                // Move all notes to unassigned
                const subject = this.subjects[subjectIndex];
                subject.notes.forEach(noteId => {
                    const note = this.notes.find(n => n.id === noteId);
                    if (note) {
                        note.subjectId = null;
                    }
                });
                
                this.subjects.splice(subjectIndex, 1);
                
                if (this.currentSubjectId === subjectId) {
                    this.currentSubjectId = null;
                }
                
                this.saveData();
                return true;
            },
            
            // Add note to subject
            addNoteToSubject(noteId, subjectId) {
                const note = this.notes.find(n => n.id === noteId);
                const subject = this.subjects.find(s => s.id === subjectId);
                
                if (!note || !subject) return false;
                
                // Remove note from previous subject
                if (note.subjectId) {
                    const prevSubject = this.subjects.find(s => s.id === note.subjectId);
                    if (prevSubject) {
                        const noteIndex = prevSubject.notes.indexOf(noteId);
                        if (noteIndex !== -1) {
                            prevSubject.notes.splice(noteIndex, 1);
                        }
                    }
                }
                
                // Add to new subject
                note.subjectId = subjectId;
                if (!subject.notes.includes(noteId)) {
                    subject.notes.push(noteId);
                }
                
                this.saveData();
                return true;
            },
            
            // Remove note from subject
            removeNoteFromSubject(noteId, subjectId) {
                const subject = this.subjects.find(s => s.id === subjectId);
                
                if (!subject) return false;
                
                const noteIndex = subject.notes.indexOf(noteId);
                if (noteIndex !== -1) {
                    subject.notes.splice(noteIndex, 1);
                }
                
                // Only update note.subjectId if note still exists (for non-deletion scenarios)
                const note = this.notes.find(n => n.id === noteId);
                if (note) {
                    note.subjectId = null;
                }
                
                this.saveData();
                return true;
            },
            
            // Search functionality
            performSearch(query) {
                this.searchQuery = query.toLowerCase();
                
                if (!this.searchQuery) {
                    this.filteredNotes = [];
                    this.renderNotes();
                    return;
                }
                
                this.filteredNotes = this.notes.filter(note => {
                    const titleMatch = note.title.toLowerCase().includes(this.searchQuery);
                    const contentMatch = note.content.toLowerCase().includes(this.searchQuery);
                    const tagMatch = note.tags.some(tag => tag.toLowerCase().includes(this.searchQuery));
                    
                    return titleMatch || contentMatch || tagMatch;
                });
                
                this.renderNotes();
                this.showNotification(`Found ${this.filteredNotes.length} notes matching "${query}"`);
            },
            
            // Toggle selection mode
            toggleSelectionMode() {
                this.isSelectionMode = !this.isSelectionMode;
                
                if (!this.isSelectionMode) {
                    this.exitSelectionMode();
                }
                
                this.renderUI();
            },
            
            // Exit selection mode
            exitSelectionMode() {
                this.isSelectionMode = false;
                this.selectedNoteIds.clear();
                document.getElementById('select-mode').classList.remove('active');
                document.getElementById('bulk-actions').classList.remove('active');
            },
            
            // Toggle note selection
            toggleNoteSelection(noteId) {
                if (this.selectedNoteIds.has(noteId)) {
                    this.selectedNoteIds.delete(noteId);
                } else {
                    this.selectedNoteIds.add(noteId);
                }
                
                this.renderNotes();
                this.updateBulkActions();
            },
            
            // Update bulk actions visibility
            updateBulkActions() {
                const bulkActions = document.getElementById('bulk-actions');
                if (this.selectedNoteIds.size > 0) {
                    bulkActions.classList.add('active');
                } else {
                    bulkActions.classList.remove('active');
                }
            },
            
            // Show all notes (remove subject filter)
            showAllNotes() {
                this.currentSubjectId = null;
                this.renderUI();
                this.showNotification('Showing all notes');
            },
            
            // Render UI
            renderUI() {
                this.renderSubjects();
                this.renderNotes();
                this.renderTrash();
                this.renderEditor();
                this.updateToolbarPriority();
            },
            
            // Render subjects
            renderSubjects() {
                const container = document.getElementById('subjects-container');
                container.innerHTML = '';
                
                if (this.subjects.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <p>No subjects yet. Create your first subject!</p>
                        </div>
                    `;
                    return;
                }
                
                this.subjects.forEach(subject => {
                    const subjectEl = document.createElement('div');
                    subjectEl.className = `subject-item ${subject.id === this.currentSubjectId ? 'active' : ''}`;
                    subjectEl.dataset.id = subject.id;
                    subjectEl.draggable = true;
                    
                    subjectEl.innerHTML = `
                        <div class="subject-icon">
                            <i class="fas fa-folder"></i>
                        </div>
                        <div class="subject-name">${subject.name}</div>
                        <div class="note-count">${subject.notes.length}</div>
                        <div class="subject-actions">
                            <button class="subject-action-btn edit-subject-btn" title="Rename Subject">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="subject-action-btn delete-subject-btn" title="Delete Subject">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    `;
                    
                    container.appendChild(subjectEl);
                });
            },
            
            // Render notes list
            renderNotes() {
                const container = document.getElementById('notes-list');
                container.innerHTML = '';
                
                let notesToRender = this.searchQuery ? this.filteredNotes : [...this.notes];
                
                // Filter by current subject if set and not searching
                if (this.currentSubjectId && !this.searchQuery) {
                    notesToRender = notesToRender.filter(note => 
                        note.subjectId === this.currentSubjectId
                    );
                }
                
                if (notesToRender.length === 0) {
                    const emptyMessage = this.searchQuery 
                        ? `No notes found for "${this.searchQuery}"` 
                        : this.currentSubjectId 
                            ? 'No notes in this subject yet.' 
                            : 'No notes yet. Create your first note!';
                            
                    container.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-sticky-note"></i>
                            <p>${emptyMessage}</p>
                        </div>
                    `;
                    return;
                }
                
                notesToRender.sort((a, b) => 
                    new Date(b.updated) - new Date(a.updated)
                ).forEach(note => {
                    const noteEl = document.createElement('div');
                    let noteClasses = `note-item ${note.id === this.currentNoteId ? 'active' : ''}`;
                    
                    if (this.isSelectionMode && this.selectedNoteIds.has(note.id)) {
                        noteClasses += ' selected';
                    }
                    
                    noteEl.className = noteClasses;
                    noteEl.dataset.id = note.id;
                    noteEl.draggable = !this.isSelectionMode;
                    
                    const tagsHtml = note.tags.map(tag => 
                        `<span class="note-tag">${tag}</span>`
                    ).join('');
                    
                    let contentPreview = note.content 
                        ? note.content.replace(/<[^>]*>/g, '').substring(0, 100) + (note.content.length > 100 ? '...' : '')
                        : 'No content';
                    
                    // Highlight search terms
                    if (this.searchQuery && contentPreview.toLowerCase().includes(this.searchQuery)) {
                        const regex = new RegExp(`(${this.searchQuery})`, 'gi');
                        contentPreview = contentPreview.replace(regex, '<span class="search-highlight">$1</span>');
                    }
                    
                    let noteTitle = note.title;
                    if (this.searchQuery && noteTitle.toLowerCase().includes(this.searchQuery)) {
                        const regex = new RegExp(`(${this.searchQuery})`, 'gi');
                        noteTitle = noteTitle.replace(regex, '<span class="search-highlight">$1</span>');
                    }
                    
                    noteEl.innerHTML = `
                        <div class="note-title">
                            ${noteTitle}
                            <span class="importance-dot ${note.importance}"></span>
                        </div>
                        <div class="note-subtitle">
                            <span><i class="far fa-clock"></i> ${note.updated}</span>
                        </div>
                        <div class="note-content-preview">${contentPreview}</div>
                        ${tagsHtml}
                    `;
                    
                    container.appendChild(noteEl);
                });
            },
            
            // Render trash list
            renderTrash() {
                const container = document.getElementById('trash-list');
                container.innerHTML = '';
                
                if (this.trash.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state" style="padding: 20px;">
                            <i class="fas fa-trash"></i>
                            <p>Trash is empty</p>
                        </div>
                    `;
                    return;
                }
                
                this.trash.forEach(item => {
                    const trashEl = document.createElement('div');
                    trashEl.className = 'trash-item';
                    trashEl.dataset.id = item.id;
                    
                    trashEl.innerHTML = `
                        <div class="trash-item-content">
                            <div class="trash-item-title">${item.title}</div>
                            <div class="trash-item-date">Deleted: ${item.deletedAt}</div>
                        </div>
                        <button class="restore-btn" title="Restore note">
                            <i class="fas fa-undo"></i>
                        </button>
                    `;
                    
                    container.appendChild(trashEl);
                });
            },
            
            // Render editor content
            renderEditor() {
                const titleField = document.getElementById('note-title-field');
                const editor = document.getElementById('note-editor');
                
                if (this.currentNoteId) {
                    const note = this.notes.find(n => n.id === this.currentNoteId);
                    if (note) {
                        titleField.value = note.title;
                        editor.innerHTML = note.content;
                    }
                } else {
                    titleField.value = '';
                    editor.innerHTML = '';
                    editor.setAttribute('data-placeholder', 'Create or select a note to begin...');
                }
            },
            
            // Update toolbar priority buttons
            updateToolbarPriority() {
                const priorityButtons = document.querySelectorAll('.priority-btn');
                priorityButtons.forEach(btn => btn.classList.remove('active'));
                
                if (this.currentNoteId) {
                    const note = this.notes.find(n => n.id === this.currentNoteId);
                    if (note) {
                        const activeButton = document.getElementById(`priority-${note.importance}`);
                        if (activeButton) {
                            activeButton.classList.add('active');
                        }
                    }
                }
            },
            
            // Render templates
            renderTemplates() {
                const container = document.getElementById('templates-container');
                container.innerHTML = '';
                
                templates.forEach(template => {
                    const templateEl = document.createElement('div');
                    templateEl.className = 'template-card';
                    templateEl.dataset.id = template.id;
                    
                    templateEl.innerHTML = `
                        <div class="template-icon">
                            <i class="${template.icon}"></i>
                        </div>
                        <div class="template-title">${template.title}</div>
                        <div class="template-description">${template.description}</div>
                        <div class="template-category">${template.category}</div>
                        <div class="template-preview">${template.content.substring(0, 200)}...</div>
                    `;
                    
                    container.appendChild(templateEl);
                });
            },
            
            // Show notification
            showNotification(message, type = 'success') {
                const container = document.getElementById('notification-container');
                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                notification.innerHTML = `
                    <i class="${type === 'success' ? 'fas fa-check-circle' : type === 'error' ? 'fas fa-exclamation-circle' : 'fas fa-exclamation-triangle'}"></i>
                    <span>${message}</span>
                `;
                
                container.appendChild(notification);
                
                // Show notification
                setTimeout(() => {
                    notification.classList.add('show');
                }, 10);
                
                // Remove after delay
                setTimeout(() => {
                    notification.classList.remove('show');
                    setTimeout(() => {
                        notification.remove();
                    }, 300);
                }, 3000);
            }
        };

        // =====================================================
        // Editor Functionality
        // =====================================================
        const EditorTools = {
            // Apply bold formatting
            toggleBold() {
                document.execCommand('bold', false, null);
                this.updateToolbarState();
            },
            
            // Apply italic formatting
            toggleItalic() {
                document.execCommand('italic', false, null);
                this.updateToolbarState();
            },
            
            // Insert bullet list
            insertBulletList() {
                document.execCommand('insertUnorderedList', false, null);
                this.updateToolbarState();
            },
            
            // Insert current date
            insertDate() {
                const now = new Date();
                const dateStr = now.toLocaleDateString();
                document.execCommand('insertText', false, dateStr);
            },
            
            // Clear editor content
            clearEditor() {
                if (confirm('Are you sure you want to clear all content?')) {
                    const editor = document.getElementById('note-editor');
                    editor.innerHTML = '';
                    
                    if (AppState.currentNoteId) {
                        AppState.updateNote(AppState.currentNoteId, { content: '' });
                    }
                    
                    AppState.showNotification('Editor cleared');
                }
            },
            
            // Update toolbar button states
            updateToolbarState() {
                const buttons = {
                    'bold-btn': document.queryCommandState('bold'),
                    'italic-btn': document.queryCommandState('italic'),
                    'bullet-btn': document.queryCommandState('insertUnorderedList')
                };
                
                Object.entries(buttons).forEach(([id, state]) => {
                    const button = document.getElementById(id);
                    if (button) {
                        button.classList.toggle('active', state);
                    }
                });
            }
        };

        // =====================================================
        // Event Handling
        // =====================================================
        const setupEventListeners = () => {
            // Search functionality
            const searchInput = document.getElementById('search-notes');
            searchInput.addEventListener('input', (e) => {
                AppState.performSearch(e.target.value);
            });
            
            // Clear search on escape
            searchInput.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    e.target.value = '';
                    AppState.performSearch('');
                }
            });
            
            // New note button
            document.getElementById('new-note').addEventListener('click', () => {
                AppState.createNote();
                AppState.renderUI();
                AppState.showNotification('New note created');
                document.getElementById('note-title-field').focus();
            });
            
            // Templates button
            document.getElementById('templates-btn').addEventListener('click', () => {
                AppState.renderTemplates();
                document.getElementById('templates-modal').classList.add('active');
            });
            
            // Template selection
            document.getElementById('templates-container').addEventListener('click', (e) => {
                const templateCard = e.target.closest('.template-card');
                if (!templateCard) return;
                
                const templateId = templateCard.dataset.id;
                const template = templates.find(t => t.id === templateId);
                
                if (template) {
                    AppState.createFromTemplate(template);
                    AppState.renderUI();
                    AppState.showNotification(`"${template.title}" template applied`);
                    document.getElementById('templates-modal').classList.remove('active');
                    document.getElementById('note-title-field').focus();
                }
            });
            
            // Close templates modal
            document.getElementById('templates-modal-close').addEventListener('click', () => {
                document.getElementById('templates-modal').classList.remove('active');
            });
            
            // Selection mode toggle
            document.getElementById('select-mode').addEventListener('click', () => {
                AppState.toggleSelectionMode();
                const button = document.getElementById('select-mode');
                button.classList.toggle('active', AppState.isSelectionMode);
                
                if (AppState.isSelectionMode) {
                    AppState.showNotification('Selection mode enabled - click notes to select');
                } else {
                    AppState.showNotification('Selection mode disabled');
                }
            });
            
            // Show all notes button
            document.getElementById('show-all-notes').addEventListener('click', () => {
                AppState.showAllNotes();
            });
            
            // Bulk delete
            document.getElementById('bulk-delete').addEventListener('click', () => {
                if (AppState.selectedNoteIds.size === 0) return;
                
                const count = AppState.selectedNoteIds.size;
                if (confirm(`Are you sure you want to delete ${count} selected note${count > 1 ? 's' : ''}?`)) {
                    AppState.bulkDeleteNotes();
                }
            });
            
            // Cancel selection
            document.getElementById('cancel-selection').addEventListener('click', () => {
                AppState.exitSelectionMode();
                AppState.renderUI();
                AppState.showNotification('Selection cancelled');
            });
            
            // Add subject button
            document.getElementById('add-subject-btn').addEventListener('click', () => {
                document.getElementById('subject-modal-title').innerHTML = '<i class="fas fa-folder"></i> Add New Subject';
                document.getElementById('subject-name').value = '';
                AppState.editingSubjectId = null;
                document.getElementById('subject-modal').classList.add('active');
                document.getElementById('subject-name').focus();
            });
            
            // Save subject button
            document.getElementById('save-subject-btn').addEventListener('click', () => {
                const subjectName = document.getElementById('subject-name').value.trim();
                if (!subjectName) {
                    AppState.showNotification('Please enter a subject name', 'error');
                    return;
                }
                
                if (AppState.editingSubjectId) {
                    AppState.renameSubject(AppState.editingSubjectId, subjectName);
                    AppState.showNotification('Subject renamed');
                } else {
                    AppState.createSubject(subjectName);
                    AppState.showNotification('New subject created');
                }
                
                AppState.renderUI();
                document.getElementById('subject-modal').classList.remove('active');
            });
            
            // Cancel subject button
            document.getElementById('cancel-subject-btn').addEventListener('click', () => {
                document.getElementById('subject-modal').classList.remove('active');
            });
            
            // Subject modal close
            document.getElementById('subject-modal-close').addEventListener('click', () => {
                document.getElementById('subject-modal').classList.remove('active');
            });
            
            // Subject name enter key
            document.getElementById('subject-name').addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    document.getElementById('save-subject-btn').click();
                }
            });
            
            // Subject edit and delete
            document.getElementById('subjects-container').addEventListener('click', (e) => {
                const subjectItem = e.target.closest('.subject-item');
                if (!subjectItem) return;
                
                const subjectId = subjectItem.dataset.id;
                
                // Edit subject
                if (e.target.closest('.edit-subject-btn')) {
                    e.stopPropagation();
                    const subject = AppState.subjects.find(s => s.id === subjectId);
                    if (subject) {
                        document.getElementById('subject-modal-title').innerHTML = '<i class="fas fa-folder"></i> Rename Subject';
                        document.getElementById('subject-name').value = subject.name;
                        AppState.editingSubjectId = subjectId;
                        document.getElementById('subject-modal').classList.add('active');
                        document.getElementById('subject-name').focus();
                    }
                    return;
                }
                
                // Delete subject
                if (e.target.closest('.delete-subject-btn')) {
                    e.stopPropagation();
                    const subject = AppState.subjects.find(s => s.id === subjectId);
                    if (confirm(`Are you sure you want to delete "${subject.name}"? Notes will be moved to unassigned.`)) {
                        AppState.deleteSubject(subjectId);
                        AppState.renderUI();
                        AppState.showNotification('Subject deleted');
                    }
                    return;
                }
                
                // Select subject (filter notes)
                AppState.currentSubjectId = subjectId;
                AppState.renderUI();
                const subject = AppState.subjects.find(s => s.id === subjectId);
                AppState.showNotification(`Showing notes for: ${subject.name}`);
            });
            
            // Toggle sidebar on mobile
            document.getElementById('toggle-sidebar').addEventListener('click', () => {
                document.getElementById('sidebar').classList.toggle('active');
            });
            
            // Notes list click handler
            document.getElementById('notes-list').addEventListener('click', (e) => {
                const noteItem = e.target.closest('.note-item');
                if (!noteItem) return;
                
                const noteId = noteItem.dataset.id;
                
                if (AppState.isSelectionMode) {
                    AppState.toggleNoteSelection(noteId);
                } else {
                    AppState.currentNoteId = noteId;
                    AppState.renderUI();
                    // Focus editor on mobile
                    if (window.innerWidth <= 768) {
                        document.getElementById('note-title-field').focus();
                    }
                }
            });
            
            // Empty trash button
            document.getElementById('empty-trash').addEventListener('click', () => {
                if (AppState.trash.length === 0) return;
                
                if (confirm('Are you sure you want to permanently delete all items in trash?')) {
                    AppState.emptyTrash();
                    AppState.renderUI();
                    AppState.showNotification('Trash emptied', 'warning');
                }
            });
            
            // Restore from trash
            document.getElementById('trash-list').addEventListener('click', (e) => {
                if (e.target.closest('.restore-btn')) {
                    const trashItem = e.target.closest('.trash-item');
                    const noteId = trashItem.dataset.id;
                    AppState.restoreNote(noteId);
                    AppState.renderUI();
                    AppState.showNotification('Note restored from trash');
                }
            });
            
            // Note title input
            document.getElementById('note-title-field').addEventListener('input', (e) => {
                if (AppState.currentNoteId) {
                    AppState.updateNote(AppState.currentNoteId, { title: e.target.value });
                    AppState.renderNotes(); // Re-render to show updated title
                }
            });
            
            // Note editor input
            const editor = document.getElementById('note-editor');
            editor.addEventListener('input', (e) => {
                if (AppState.currentNoteId) {
                    AppState.updateNote(AppState.currentNoteId, { content: e.target.innerHTML });
                }
            });
            
            // Editor toolbar events
            document.getElementById('bold-btn').addEventListener('click', () => {
                EditorTools.toggleBold();
            });
            
            document.getElementById('italic-btn').addEventListener('click', () => {
                EditorTools.toggleItalic();
            });
            
            document.getElementById('bullet-btn').addEventListener('click', () => {
                EditorTools.insertBulletList();
            });
            
            document.getElementById('date-btn').addEventListener('click', () => {
                EditorTools.insertDate();
            });
            
            document.getElementById('clear-btn').addEventListener('click', () => {
                EditorTools.clearEditor();
            });
            
            // Priority buttons
            document.querySelectorAll('.priority-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    if (!AppState.currentNoteId) return;
                    
                    const priority = btn.id.replace('priority-', '');
                    AppState.updateNote(AppState.currentNoteId, { importance: priority });
                    AppState.renderUI();
                    AppState.showNotification(`Priority set to ${priority}`);
                });
            });
            
            // Remind me button (placeholder)
            document.getElementById('remind-me-btn').addEventListener('click', () => {
                AppState.showNotification('Reminder feature coming soon!', 'warning');
            });
            
            // Editor selection change to update toolbar
            editor.addEventListener('selectionchange', () => {
                EditorTools.updateToolbarState();
            });
            
            editor.addEventListener('keyup', () => {
                EditorTools.updateToolbarState();
            });
            
            // Context menu handling
            setupContextMenu();
            
            // Drag and drop handling
            setupDragAndDrop();
            
            // Keyboard shortcuts
            setupKeyboardShortcuts();
            
            // Modal overlay clicks
            document.querySelectorAll('.modal-overlay').forEach(overlay => {
                overlay.addEventListener('click', (e) => {
                    if (e.target === overlay) {
                        overlay.classList.remove('active');
                    }
                });
            });
        };

        // =====================================================
        // Keyboard Shortcuts
        // =====================================================
        const setupKeyboardShortcuts = () => {
            document.addEventListener('keydown', (e) => {
                // Ctrl/Cmd + N: New note
                if ((e.ctrlKey || e.metaKey) && e.key === 'n') {
                    e.preventDefault();
                    document.getElementById('new-note').click();
                }
                
                // Ctrl/Cmd + S: Save (already auto-saves, just show notification)
                if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                    e.preventDefault();
                    AppState.showNotification('Auto-saved!');
                }
                
                // Ctrl/Cmd + F: Focus search
                if ((e.ctrlKey || e.metaKey) && e.key === 'f') {
                    e.preventDefault();
                    document.getElementById('search-notes').focus();
                }
                
                // Ctrl/Cmd + D: Delete current note
                if ((e.ctrlKey || e.metaKey) && e.key === 'd') {
                    e.preventDefault();
                    if (AppState.currentNoteId) {
                        AppState.deleteNote(AppState.currentNoteId);
                        AppState.renderUI();
                        AppState.showNotification('Note moved to trash', 'warning');
                    }
                }
                
                // Escape: Exit selection mode or close modals
                if (e.key === 'Escape') {
                    if (AppState.isSelectionMode) {
                        AppState.exitSelectionMode();
                        AppState.renderUI();
                    }
                    
                    document.querySelectorAll('.modal-overlay.active').forEach(modal => {
                        modal.classList.remove('active');
                    });
                }
                
                // Ctrl/Cmd + A: Select all notes (in selection mode)
                if ((e.ctrlKey || e.metaKey) && e.key === 'a' && AppState.isSelectionMode) {
                    e.preventDefault();
                    let notesToSelect = AppState.searchQuery ? AppState.filteredNotes : [...AppState.notes];
                    
                    if (AppState.currentSubjectId && !AppState.searchQuery) {
                        notesToSelect = notesToSelect.filter(note => note.subjectId === AppState.currentSubjectId);
                    }
                    
                    notesToSelect.forEach(note => AppState.selectedNoteIds.add(note.id));
                    AppState.renderNotes();
                    AppState.updateBulkActions();
                    AppState.showNotification(`Selected ${notesToSelect.length} notes`);
                }
            });
        };

        // =====================================================
        // Context Menu Functionality
        // =====================================================
        const setupContextMenu = () => {
            const contextMenu = document.getElementById('context-menu');
            
            // Show context menu on right-click
            document.getElementById('notes-list').addEventListener('contextmenu', (e) => {
                e.preventDefault();
                
                const noteItem = e.target.closest('.note-item');
                if (noteItem) {
                    AppState.contextNoteId = noteItem.dataset.id;
                    const note = AppState.notes.find(n => n.id === AppState.contextNoteId);
                    
                    if (note) {
                        // Highlight current priority
                        document.querySelectorAll('.priority-option').forEach(opt => {
                            opt.classList.remove('selected');
                            if (opt.dataset.priority === note.importance) {
                                opt.classList.add('selected');
                            }
                        });
                        
                        // Position context menu
                        contextMenu.style.display = 'block';
                        
                        // Calculate position to keep menu on screen
                        const menuWidth = 200;
                        const menuHeight = 300;
                        let x = e.pageX;
                        let y = e.pageY;
                        
                        if (x + menuWidth > window.innerWidth) {
                            x = window.innerWidth - menuWidth - 10;
                        }
                        
                        if (y + menuHeight > window.innerHeight) {
                            y = window.innerHeight - menuHeight - 10;
                        }
                        
                        contextMenu.style.left = `${x}px`;
                        contextMenu.style.top = `${y}px`;
                    }
                }
            });
            
            // Hide context menu when clicking elsewhere
            document.addEventListener('click', () => {
                contextMenu.style.display = 'none';
            });
            
            // Prevent context menu from closing when clicking inside it
            contextMenu.addEventListener('click', (e) => {
                e.stopPropagation();
            });
            
            // Delete note option
            document.getElementById('context-delete').addEventListener('click', () => {
                if (AppState.contextNoteId) {
                    AppState.deleteNote(AppState.contextNoteId);
                    AppState.renderUI();
                    AppState.showNotification('Note moved to trash', 'warning');
                    contextMenu.style.display = 'none';
                }
            });
            
            // Duplicate note option
            document.getElementById('context-duplicate').addEventListener('click', () => {
                if (AppState.contextNoteId) {
                    const note = AppState.notes.find(n => n.id === AppState.contextNoteId);
                    if (note) {
                        const newNote = {
                            ...note,
                            id: 'note' + Date.now(),
                            title: note.title + ' (Copy)',
                            created: new Date().toISOString().split('T')[0],
                            updated: new Date().toISOString().split('T')[0]
                        };
                        
                        AppState.notes.unshift(newNote);
                        AppState.currentNoteId = newNote.id;
                        
                        if (newNote.subjectId) {
                            AppState.addNoteToSubject(newNote.id, newNote.subjectId);
                        }
                        
                        AppState.saveData();
                        AppState.renderUI();
                        AppState.showNotification('Note duplicated');
                    }
                    contextMenu.style.display = 'none';
                }
            });
            
            // Priority selector
            document.querySelectorAll('.priority-option').forEach(option => {
                option.addEventListener('click', () => {
                    if (AppState.contextNoteId) {
                        AppState.updateNote(AppState.contextNoteId, { 
                            importance: option.dataset.priority 
                        });
                        AppState.renderUI();
                        AppState.showNotification(`Priority set to ${option.dataset.priority}`);
                        contextMenu.style.display = 'none';
                    }
                });
            });
            
            // Add tag option
            document.getElementById('context-add-tag').addEventListener('click', () => {
                if (AppState.contextNoteId) {
                    const tag = prompt('Enter a tag for this note:');
                    if (tag && tag.trim()) {
                        const note = AppState.notes.find(n => n.id === AppState.contextNoteId);
                        if (note && !note.tags.includes(tag.trim())) {
                            note.tags.push(tag.trim());
                            AppState.saveData();
                            AppState.renderUI();
                            AppState.showNotification(`Tag "${tag.trim()}" added to note`);
                        } else if (note.tags.includes(tag.trim())) {
                            AppState.showNotification('Tag already exists on this note', 'warning');
                        }
                    }
                    contextMenu.style.display = 'none';
                }
            });
            
            // Set reminder option
            document.getElementById('context-set-reminder').addEventListener('click', () => {
                AppState.showNotification('Reminder feature coming soon!', 'warning');
                contextMenu.style.display = 'none';
            });
        };

        // =====================================================
        // Drag and Drop Functionality
        // =====================================================
        const setupDragAndDrop = () => {
            let draggedNoteId = null;
            
            // Note drag start
            document.addEventListener('dragstart', (e) => {
                if (e.target.classList.contains('note-item') && !AppState.isSelectionMode) {
                    draggedNoteId = e.target.dataset.id;
                    e.target.classList.add('dragging');
                    e.dataTransfer.effectAllowed = 'move';
                    e.dataTransfer.setData('text/html', e.target.outerHTML);
                }
            });
            
            // Note drag end
            document.addEventListener('dragend', (e) => {
                if (e.target.classList.contains('note-item')) {
                    e.target.classList.remove('dragging');
                    // Clean up any remaining drag-over classes
                    document.querySelectorAll('.drag-over').forEach(el => {
                        el.classList.remove('drag-over');
                    });
                    draggedNoteId = null;
                }
            });
            
            // Subject drag over
            document.addEventListener('dragover', (e) => {
                const subjectItem = e.target.closest('.subject-item');
                if (subjectItem && draggedNoteId) {
                    e.preventDefault();
                    e.dataTransfer.dropEffect = 'move';
                    subjectItem.classList.add('drag-over');
                }
                
                const trashSection = e.target.closest('#trash-section');
                if (trashSection && draggedNoteId) {
                    e.preventDefault();
                    e.dataTransfer.dropEffect = 'move';
                    trashSection.classList.add('drag-over');
                }
            });
            
            // Subject drag leave
            document.addEventListener('dragleave', (e) => {
                const subjectItem = e.target.closest('.subject-item');
                if (subjectItem) {
                    // Only remove if we're leaving the subject item entirely
                    const rect = subjectItem.getBoundingClientRect();
                    const x = e.clientX;
                    const y = e.clientY;
                    
                    if (x < rect.left || x > rect.right || y < rect.top || y > rect.bottom) {
                        subjectItem.classList.remove('drag-over');
                    }
                }
                
                const trashSection = e.target.closest('#trash-section');
                if (trashSection) {
                    const rect = trashSection.getBoundingClientRect();
                    const x = e.clientX;
                    const y = e.clientY;
                    
                    if (x < rect.left || x > rect.right || y < rect.top || y > rect.bottom) {
                        trashSection.classList.remove('drag-over');
                    }
                }
            });
            
            // Subject drop
            document.addEventListener('drop', (e) => {
                e.preventDefault();
                
                const subjectItem = e.target.closest('.subject-item');
                if (subjectItem && draggedNoteId) {
                    subjectItem.classList.remove('drag-over');
                    const subjectId = subjectItem.dataset.id;
                    
                    AppState.addNoteToSubject(draggedNoteId, subjectId);
                    AppState.renderUI();
                    const subject = AppState.subjects.find(s => s.id === subjectId);
                    AppState.showNotification(`Note moved to ${subject.name}`);
                    return;
                }
                
                const trashSection = e.target.closest('#trash-section');
                if (trashSection && draggedNoteId) {
                    trashSection.classList.remove('drag-over');
                    AppState.deleteNote(draggedNoteId);
                    AppState.renderUI();
                    AppState.showNotification('Note moved to trash', 'warning');
                    return;
                }
            });
        };

        // =====================================================
        // Initialize App
        // =====================================================
        document.addEventListener('DOMContentLoaded', () => {
            try {
                AppState.init();
                setupEventListeners();
                
                // Show welcome notification
                setTimeout(() => {
                    AppState.showNotification('Welcome to ProNotes Advanced! 📝');
                }, 1000);
                
                // Show keyboard shortcuts after a delay
                setTimeout(() => {
                    AppState.showNotification('💡 Tip: Press Ctrl+N for new note, Ctrl+F to search!');
                }, 4000);
                
            } catch (error) {
                console.error('Error initializing app:', error);
                document.body.innerHTML = `
                    <div style="display: flex; align-items: center; justify-content: center; height: 100vh; text-align: center; font-family: sans-serif;">
                        <div>
                            <h1>❌ Error Loading ProNotes</h1>
                            <p>There was an error loading the application. Please refresh the page.</p>
                            <button onclick="location.reload()" style="padding: 10px 20px; margin-top: 20px; background: #4361ee; color: white; border: none; border-radius: 5px; cursor: pointer;">
                                Refresh Page
                            </button>
                        </div>
                    </div>
                `;
            }
        });
    </script>
</body>
</html>
